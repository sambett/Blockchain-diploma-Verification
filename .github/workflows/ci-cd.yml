name: ğŸ“ Diploma Verification System CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18.x'

jobs:
  test:
    name: ğŸ§ª Smart Contract Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ”¨ Compile contracts
      run: npm run compile
      
    - name: ğŸ§ª Run tests
      run: npm test
      
    - name: ğŸ“Š Generate test coverage
      run: npx hardhat coverage || true
      
    - name: ğŸ’¾ Upload coverage reports
      uses: codecov/codecov-action@v3
      if: success()
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: false

  security:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ” Audit dependencies
      run: npm audit --audit-level moderate
      
    - name: ğŸ›¡ï¸ Run Slither analysis (if available)
      run: |
        if command -v slither &> /dev/null; then
          slither . --exclude-dependencies || echo "Slither analysis completed with warnings"
        else
          echo "Slither not available, skipping security analysis"
        fi

  deploy-testnet:
    name: ğŸš€ Deploy to Sepolia Testnet
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: testnet
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ”¨ Compile contracts
      run: npm run compile
      
    - name: ğŸŒ Deploy to Sepolia
      env:
        PRIVATE_KEY: ${{ secrets.SEPOLIA_PRIVATE_KEY }}
        ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY }}
        ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
      run: |
        if [ -n "$PRIVATE_KEY" ] && [ -n "$ALCHEMY_API_KEY" ]; then
          npm run deploy:sepolia
          echo "âœ… Deployment to Sepolia completed"
        else
          echo "âš ï¸ Sepolia deployment skipped - missing required secrets"
        fi
        
    - name: ğŸ” Verify deployment
      env:
        ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY }}
      run: |
        if [ -n "$ALCHEMY_API_KEY" ]; then
          npm run verify:sepolia || echo "âš ï¸ Verification completed with warnings"
        else
          echo "âš ï¸ Deployment verification skipped - missing API key"
        fi

  frontend-check:
    name: ğŸŒ Frontend Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate HTML
      run: |
        # Basic HTML validation
        if command -v tidy &> /dev/null; then
          tidy -q -e frontend/src/index.html || echo "HTML validation completed with warnings"
        else
          echo "HTML Tidy not available, performing basic checks"
          grep -q "<!DOCTYPE html>" frontend/src/index.html && echo "âœ… DOCTYPE found"
          grep -q "<html" frontend/src/index.html && echo "âœ… HTML tag found"
          grep -q "</html>" frontend/src/index.html && echo "âœ… Closing HTML tag found"
        fi
        
    - name: ğŸ” Check JavaScript syntax
      run: |
        # Basic JavaScript syntax check
        node -c frontend/src/index.html && echo "âœ… No syntax errors found" || echo "âš ï¸ Check JavaScript syntax manually"

  documentation:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Check documentation files
      run: |
        echo "ğŸ“‹ Checking for required documentation files..."
        
        files=("README.md" "docs/README.md" "frontend/README.md" "PROJECT_STATUS.md")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
            # Check if file is not empty
            if [ -s "$file" ]; then
              echo "   ğŸ“„ File has content"
            else
              echo "   âš ï¸ File is empty"
            fi
          else
            echo "âŒ $file missing"
          fi
        done
        
    - name: ğŸ“Š Repository statistics
      run: |
        echo "ğŸ“Š Repository Statistics:"
        echo "   ğŸ“ Total files: $(find . -type f | wc -l)"
        echo "   ğŸ’» Solidity files: $(find . -name "*.sol" | wc -l)"
        echo "   ğŸ§ª Test files: $(find . -name "*.test.js" | wc -l)"
        echo "   ğŸ“„ Documentation files: $(find . -name "*.md" | wc -l)"
        echo "   ğŸŒ Frontend files: $(find frontend -name "*.html" -o -name "*.js" -o -name "*.css" | wc -l)"

  status-report:
    name: ğŸ“Š Build Status Report
    runs-on: ubuntu-latest
    needs: [test, security, frontend-check, documentation]
    if: always()
    
    steps:
    - name: ğŸ“Š Generate Status Report
      run: |
        echo "ğŸ“ Diploma Verification System - Build Report"
        echo "=============================================="
        echo ""
        echo "ğŸ“Š Job Results:"
        echo "   ğŸ§ª Tests: ${{ needs.test.result }}"
        echo "   ğŸ”’ Security: ${{ needs.security.result }}"
        echo "   ğŸŒ Frontend: ${{ needs.frontend-check.result }}"
        echo "   ğŸ“š Documentation: ${{ needs.documentation.result }}"
        echo ""
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.security.result }}" == "success" ] && [ "${{ needs.frontend-check.result }}" == "success" ] && [ "${{ needs.documentation.result }}" == "success" ]; then
          echo "âœ… All checks passed! Project is ready for deployment."
        else
          echo "âš ï¸ Some checks failed. Please review the results above."
        fi
        echo ""
        echo "ğŸ”— Repository: https://github.com/sambett/Blockchain-diploma-Verification"
        echo "ğŸ“š Documentation: See README.md for setup instructions"
